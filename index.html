<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gravador Inteligente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root{
      --bg:#0f1216;--panel:#151a21;--muted:#9aa4b2;--text:#e6eef8;
      --primary:#4cc9f0;--border:#263041;--success:#22c55e;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:
        radial-gradient(1200px 600px at 10% -10%, #1a2230 0%, transparent 55%),
        radial-gradient(1200px 600px at 110% 10%, #161e27 0%, transparent 55%),
        var(--bg);
      color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      min-height:100vh;display:grid;place-items:center;padding:24px;
    }
    .card{
      width:100%;max-width:920px;background:linear-gradient(180deg,#11161c 0%,#0e1217 100%);
      border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.35)
    }
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap
    }
    h1{margin:0;font-size:clamp(20px,3vw,28px)}
    .badge{
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;letter-spacing:.3px;
      border:1px solid var(--border);background:#10151d;color:var(--muted);white-space:nowrap
    }
    .subtitle{
      color:var(--muted);margin:10px 0 18px;font-size:14px;line-height:1.35;
      word-break:break-word;overflow-wrap:anywhere
    }
    code{background:#0f1420;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .controls{
      display:grid;gap:10px;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      align-items:stretch
    }
    button{
      appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);
      padding:12px 14px;border-radius:10px;font-weight:600;letter-spacing:.2px;
      display:inline-flex;align-items:center;gap:8px;cursor:pointer;
      transition:transform .08s ease,background .2s ease,border-color .2s ease,opacity .2s ease;
      user-select:none;min-height:44px;justify-content:center
    }
    button:hover{background:#1a2029;border-color:#2e3a4f}
    button:active{transform:translateY(1px)}
    button[disabled]{opacity:.45;cursor:not-allowed;filter:grayscale(.2)}
    .status{
      margin-top:14px;font-size:14px;display:flex;align-items:center;gap:8px;min-height:24px;color:var(--muted)
    }
    .status.ok{color:var(--success)}
    .status.err{color:var(--danger)}
    .panel{
      margin-top:18px;padding:14px;border-radius:12px;background:#0f1420;border:1px solid var(--border)
    }
    .meta{margin-top:8px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .meta strong{color:var(--text)}
    .link a{color:var(--primary);text-decoration:none}
    .link a:hover{text-decoration:underline}
    .spacer{height:6px}
    audio{width:100%;margin-top:10px}
    @media (max-width:480px){ .controls{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <h1>Gravador Inteligente</h1>
      <span class="badge" id="badgeState">pronto</span>
    </div>

    <div class="subtitle">
      Grave, finalize e gere sua documentação. • Limite: <code>25&nbsp;MB</code>
    </div>

    <div class="controls">
      <button id="btnStart"><i data-lucide="mic"></i>Começar</button>
      <button id="btnStop" style="display:none;"><i data-lucide="square"></i>Parar</button>
      <button id="btnFinalize" style="display:none;"><i data-lucide="check-circle-2"></i>Finalizar</button>
      <button id="btnPlay" style="display:none;"><i data-lucide="play-circle"></i>Ouvir</button>
      <button id="btnGenerateReq" style="display:none;"><i data-lucide="file-text"></i>Gerar requisitos</button>
      <button id="btnGenerateAta" style="display:none;"><i data-lucide="file-signature"></i>Gerar ata</button>
      <button id="btnResend" style="display:none;"><i data-lucide="repeat-2"></i>Reenviar</button>
    </div>

    <div class="panel">
      <div id="status" class="status"><i data-lucide="info"></i><span>Pronto para gravar.</span></div>
      <div id="meta" class="meta" style="display:none;">
        <i data-lucide="hard-drive"></i>
        <span>Tamanho do arquivo: <strong id="fileSize">—</strong></span>
        <span id="sizeWarn" style="display:none;color:var(--danger);font-weight:700;">Excede 25&nbsp;MB</span>
      </div>
      <div class="spacer"></div>
      <div id="result" class="link"></div>
      <audio id="player" controls style="display:none;"></audio>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded',()=>{ lucide.createIcons(); });

    // ===== Config =====
    const MAX_BYTES = 25 * 1024 * 1024; // 25 MB
    const ENDPOINTS = {
      requisitos: 'http://localhost:5678/webhook/audio',
      ata:        'http://localhost:5678/webhook/ata-reuniao',
    };

    // ===== Estados =====
    let mediaRecorder=null, stream=null, chunks=[], audioBlob=null;
    let audioUrl=null, hasTriedSend=false, isRecording=false, hasStarted=false, isFinalized=false;
    let isTooLarge=false;

    // ===== UI refs =====
    const badge=document.getElementById('badgeState');
    const statusEl=document.getElementById('status');
    const resultEl=document.getElementById('result');
    const player=document.getElementById('player');
    const meta=document.getElementById('meta');
    const fileSizeEl=document.getElementById('fileSize');
    const sizeWarn=document.getElementById('sizeWarn');

    const btnStart=document.getElementById('btnStart');
    const btnStop=document.getElementById('btnStop');
    const btnFinalize=document.getElementById('btnFinalize');
    const btnPlay=document.getElementById('btnPlay');
    const btnGenerateReq=document.getElementById('btnGenerateReq');
    const btnGenerateAta=document.getElementById('btnGenerateAta');
    const btnResend=document.getElementById('btnResend');

    // ===== Helpers =====
    const formatBytes = (bytes) => {
      if (bytes === 0 || bytes == null) return '0 B';
      const units = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      const val = bytes / Math.pow(1024, i);
      return `${val.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
    };

    function setStatus(text,type='info',icon='info'){
      statusEl.className='status'+(type==='ok'?' ok':type==='err'?' err':'');
      statusEl.innerHTML=`<i data-lucide="${icon}"></i><span>${text}</span>`;
      lucide.createIcons();
    }

    function updateUI(){
      btnStop.style.display=isRecording?'inline-flex':'none';
      btnStop.disabled=!isRecording;

      btnFinalize.style.display=hasStarted?'inline-flex':'none';
      btnFinalize.disabled=!hasStarted;

      btnPlay.style.display=isFinalized?'inline-flex':'none';
      btnPlay.disabled=!isFinalized;

      // bloqueia envios se excedeu limite
      const canSend = isFinalized && !isTooLarge;
      btnGenerateReq.style.display=isFinalized?'inline-flex':'none';
      btnGenerateReq.disabled=!canSend;

      btnGenerateAta.style.display=isFinalized?'inline-flex':'none';
      btnGenerateAta.disabled=!canSend;

      btnResend.style.display=hasTriedSend && canSend ? 'inline-flex' : 'none';

      btnStart.disabled=isRecording;
      player.style.display=isFinalized?'block':'none';

      badge.textContent = isRecording ? 'gravando…'
        : isFinalized ? 'finalizado'
        : hasStarted ? 'em andamento' : 'pronto';
    }

    // ===== Gravação =====
    async function startRecording(){
      try{
        chunks=[]; audioBlob=null; audioUrl=null; isFinalized=false; hasStarted=true; isTooLarge=false;
        meta.style.display='none'; sizeWarn.style.display='none'; fileSizeEl.textContent='—';

        stream=await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder=new MediaRecorder(stream);
        mediaRecorder.ondataavailable=e=>{ if(e.data && e.data.size) chunks.push(e.data); };
        mediaRecorder.onstop=()=>{ isRecording=false; setStatus('Gravação parada. Clique em Finalizar para gerar o áudio.','info','pause-circle'); updateUI(); };
        mediaRecorder.start();
        isRecording=true; setStatus('Gravando…','info','mic'); updateUI();
      }catch(err){ setStatus('Erro ao acessar o microfone: '+err.message,'err','alert-triangle'); }
    }

    function stopRecording(){
      if(mediaRecorder && isRecording){
        mediaRecorder.stop();
        if(stream) stream.getTracks().forEach(t=>t.stop());
      }
    }

    function finalizeRecording(){
      if(isRecording) stopRecording();
      if(!chunks.length){ setStatus('Nenhum áudio capturado ainda. Grave algo antes.','err','alert-octagon'); return; }

      // Cria blob e mede tamanho
      audioBlob=new Blob(chunks,{type:'audio/webm'});
      audioUrl=URL.createObjectURL(audioBlob);
      player.src=audioUrl; isFinalized=true;

      // Exibe tamanho
      const size = audioBlob.size || 0;
      meta.style.display='flex';
      fileSizeEl.textContent = formatBytes(size);
      isTooLarge = size > MAX_BYTES;
      sizeWarn.style.display = isTooLarge ? 'inline' : 'none';

      if(isTooLarge){
        setStatus(`Áudio finalizado, porém excede o limite de 25 MB (${formatBytes(size)}). Regrave trechos menores ou comprima antes de enviar.`,'err','alert-octagon');
      }else{
        setStatus('Áudio finalizado. Você pode ouvir e gerar a documentação.','ok','check-circle-2');
      }
      updateUI();
    }

    // ===== Envio =====
    async function sendTo(endpointUrl){
      if(!audioBlob){ setStatus('Finalize a gravação antes de enviar.','err','alert-triangle'); return; }
      if(isTooLarge){
        setStatus('Arquivo excede 25 MB. Reduza a duração ou qualidade antes do envio.','err','alert-octagon'); return;
      }

      setStatus('Enviando…','info','upload');
      const form=new FormData(); form.append('data',audioBlob,'gravacao.webm');

      try{
        const resp=await fetch(endpointUrl,{method:'POST',body:form});
        let json=null; try{ json=await resp.json(); }catch{}
        hasTriedSend=true;
        if(resp.ok){
          setStatus('Enviado com sucesso.','ok','check-circle'); resultEl.innerHTML='';
          const link=json?.pageUrl||json?.url;
          if(link){ resultEl.innerHTML=`📄 <a href="${link}" target="_blank" rel="noreferrer">Acessar documento</a>`; }
          else if(json){ resultEl.textContent=JSON.stringify(json,null,2); }
          else{ resultEl.textContent='Enviado com sucesso.'; }
        }else{
          setStatus(`Falha no envio (${resp.status}).`,'err','x-circle');
          resultEl.textContent=json?JSON.stringify(json,null,2):'Sem corpo de resposta.';
        }
      }catch(e){
        hasTriedSend=true; setStatus('Erro de conexão ao enviar.','err','wifi-off');
        resultEl.textContent=e?.message||String(e);
      }finally{ updateUI(); }
    }

    // ===== Listeners =====
    btnStart.addEventListener('click',startRecording);
    btnStop.addEventListener('click',stopRecording);
    btnFinalize.addEventListener('click',finalizeRecording);
    btnPlay.addEventListener('click',()=>player.play());
    btnGenerateReq.addEventListener('click',()=>sendTo(ENDPOINTS.requisitos));
    btnGenerateAta.addEventListener('click',()=>sendTo(ENDPOINTS.ata));
    btnResend.addEventListener('click',()=>sendTo(ENDPOINTS.requisitos));

    // ===== Init =====
    updateUI(); setStatus('Pronto para gravar.','info','info');
  </script>
</body>
</html>
